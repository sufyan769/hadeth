
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>البحث في الأحاديث</title>
  <meta name="description" content="البحث في الأحاديث النبوية الشريفة والفتاوى.">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background-color: #FDF6E3; /* Vintage paper background */
    }
    .simpson-border {
      border: 3px solid black;
      box-shadow: 4px 4px 0 #000;
      border-radius: 0.75rem;
      transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out;
    }
    .simpson-border:hover {
        transform: translate(-2px, -2px);
        box-shadow: 6px 6px 0 #000;
    }
    .simpson-button {
      border: 3px solid black;
      box-shadow: 4px 4px 0 #000;
      transition: all 0.1s ease-in-out;
      font-weight: 700;
    }
    .simpson-button:active {
      transform: translate(4px, 4px);
      box-shadow: none;
    }
     .animate-spin {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .hadith-card {
        background-color: #FFFBF2;
    }
  </style>
</head>
<body class="text-stone-900">

  <div class="min-h-screen">
    <main class="container mx-auto px-4 py-8 md:py-12">
      <header class="text-center mb-8">
        <a href="./" data-navigate class="text-4xl md:text-5xl font-black text-stone-800 no-underline hover:text-amber-700 transition-colors">
          <h1>البحث في الأحاديث</h1>
        </a>
        <p class="text-lg text-stone-600 mt-2 font-bold">
          موسوعة الحديث النبوي الشريف
        </p>
      </header>
      
      <!-- Views Container -->
      <div id="views-container" class="max-w-4xl mx-auto">
        
        <!-- Home/Search View -->
        <div id="home-view">
          <form id="searchForm" class="flex items-center gap-3 mb-8">
            <div class="relative w-full">
              <input
                id="searchBox"
                type="text"
                placeholder="ابحث عن حديث..."
                class="simpson-border w-full text-lg md:text-xl py-3 px-5 border-black rounded-full shadow-sm focus:outline-none transition-shadow duration-200 bg-white"
                autofocus
              />
            </div>
            <button type="submit" class="simpson-button px-6 py-3 bg-amber-400 text-black text-lg rounded-full hover:bg-amber-500 focus:outline-none flex-shrink-0">
              بحث
            </button>
          </form>
          <div id="home-content-container">
            <!-- Featured Hadith or Search Results will be rendered here -->
          </div>
        </div>

        <!-- Details View -->
        <div id="details-view" class="hidden">
          <!-- Hadith details will be rendered here -->
        </div>

        <!-- Category View -->
        <div id="category-view" class="hidden">
           <!-- Category results will be rendered here -->
        </div>
        
        <!-- Global Loader -->
        <div id="loader-view" class="hidden">
            <div class="flex justify-center items-center py-20">
                <div class="w-16 h-16 border-4 border-amber-500 border-t-transparent rounded-full animate-spin"></div>
            </div>
        </div>

      </div>
    </main>
  </div>
  
  <div id="fab-container" class="fixed bottom-4 right-4 flex items-center gap-3 z-50">
      <button id="back-btn" class="hidden simpson-button bg-stone-700 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:bg-stone-800" aria-label="العودة" title="العودة">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" />
          </svg>
      </button>
      <button id="font-size-toggle-btn" class="simpson-button bg-amber-500 text-black w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-2xl font-black hover:bg-amber-600" aria-label="تغيير حجم الخط" title="تغيير حجم الخط">
          A+
      </button>
  </div>


  <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIG & CONSTANTS ---
        const ALGOLIA_APP_ID = "3XD12I7386";
        const ALGOLIA_SEARCH_KEY = "89e8e132a05fdb02275f64dec8d14d05";
        const ALGOLIA_INDEX_NAME = "hadeth-2";
        const ORDS_API_BASE_URL = "https://g85b062bd5c6cb1-fatwaproject.adb.me-dubai-1.oraclecloudapps.com/ords/SUFEAN/hadith_full_api";
        const FONT_SIZES = [16, 18, 20, 24];
        const LS_FONT_KEY = 'hadithAppFontSize';

        // --- DOM ELEMENTS ---
        const views = {
            home: document.getElementById('home-view'),
            details: document.getElementById('details-view'),
            category: document.getElementById('category-view'),
            loader: document.getElementById('loader-view'),
        };
        const searchForm = document.getElementById('searchForm');
        const searchBox = document.getElementById('searchBox');
        const homeContentContainer = document.getElementById('home-content-container');
        const backBtn = document.getElementById('back-btn');
        const fontSizeToggleBtn = document.getElementById('font-size-toggle-btn');
        const fabContainer = document.getElementById('fab-container');

        // --- ALGOLIA CLIENT ---
        if (typeof algoliasearch === 'undefined') {
          console.error('Algolia client not loaded.');
          views.home.innerHTML = `<p class="text-center text-red-500 py-10">لا يمكن تحميل خدمة البحث.</p>`;
          return;
        }
        const client = algoliasearch(ALGOLIA_APP_ID, ALGOLIA_SEARCH_KEY);
        const index = client.initIndex(ALGOLIA_INDEX_NAME);

        // --- STATE & HELPERS ---
        const sanitizeHTML = (str) => str.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        
        const showView = (viewName) => {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (views[viewName]) views[viewName].classList.remove('hidden');
            backBtn.classList.toggle('hidden', viewName === 'home');
        };

        const showLoader = (container) => {
            container.innerHTML = `
                <div class="flex justify-center items-center py-10">
                    <div class="w-10 h-10 border-4 border-amber-500 border-t-transparent rounded-full animate-spin"></div>
                </div>`;
        };
        
        // --- SHARED: FONT SIZE CONTROL ---
        const applyFontSize = (size) => {
            document.documentElement.style.fontSize = `${size}px`;
            localStorage.setItem(LS_FONT_KEY, size);
        };
        const initFontSizeControl = () => {
            const savedSize = localStorage.getItem(LS_FONT_KEY);
            if (savedSize) applyFontSize(parseInt(savedSize, 10));

            fontSizeToggleBtn.addEventListener('click', () => {
                const currentSize = parseInt(localStorage.getItem(LS_FONT_KEY) || FONT_SIZES[0], 10);
                const currentIndex = FONT_SIZES.indexOf(currentSize) !== -1 ? FONT_SIZES.indexOf(currentSize) : 0;
                const nextIndex = (currentIndex + 1) % FONT_SIZES.length;
                applyFontSize(FONT_SIZES[nextIndex]);
            });
        };

        // --- SHARED: DRAGGABLE FAB ---
        const initDraggable = (element) => {
          let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
          element.onmousedown = dragMouseDown;

          function dragMouseDown(e) {
              if (e.target.closest('button, a')) return;
              e.preventDefault();
              pos3 = e.clientX;
              pos4 = e.clientY;
              document.onmouseup = closeDragElement;
              document.onmousemove = elementDrag;
          }

          function elementDrag(e) {
              e.preventDefault();
              pos1 = pos3 - e.clientX;
              pos2 = pos4 - e.clientY;
              pos3 = e.clientX;
              pos4 = e.clientY;
              element.style.top = (element.offsetTop - pos2) + "px";
              element.style.left = (element.offsetLeft - pos1) + "px";
              element.style.bottom = 'auto';
              element.style.right = 'auto';
          }

          function closeDragElement() {
              document.onmouseup = null;
              document.onmousemove = null;
          }
        };

        // --- HOME / SEARCH PAGE LOGIC ---
        const renderFeaturedHadith = async (container) => {
            showLoader(container);
            try {
                const randomPage = Math.floor(Math.random() * 100);
                let { hits } = await index.search('', { hitsPerPage: 1, page: randomPage });
                if (hits.length === 0) {
                   const fallbackResult = await index.search('', { hitsPerPage: 1, page: 0 });
                   hits = fallbackResult.hits;
                }
                const hadith = hits[0];
                if (!hadith) throw new Error("No featured hadith found.");
                
                container.innerHTML = `
                    <h2 class="text-2xl font-black text-stone-800 mb-4">حديث اليوم</h2>
                    <a href="./?id=${hadith.objectID}" class="block hadith-card p-6 simpson-border" data-navigate>
                        <p class="text-stone-800 leading-relaxed text-xl">${hadith.text}</p>
                    </a>
                `;
            } catch (err) {
                console.error("Failed to fetch featured hadith:", err);
                container.innerHTML = `<div class="text-center py-6 px-4 hadith-card simpson-border"><p class="text-stone-600">تعذر تحميل حديث اليوم.</p></div>`;
            }
        };

        const renderSearchResults = (hits, container) => {
            const resultsHTML = hits.map(hit => {
                const content = hit._highlightResult?.text.value || hit.text;
                return `
                  <a href="./?id=${hit.objectID}" class="block hadith-card p-5 simpson-border" data-navigate>
                    <p class="text-stone-800 leading-relaxed text-lg">
                      ${content.replace(/<em>/g, '<em class="bg-amber-300 not-italic font-semibold">')}
                    </p>
                  </a>`;
            }).join('');
            container.innerHTML = `<div class="space-y-6">${resultsHTML}</div>`;
        };

        const runSearch = async (query) => {
            const trimmedQuery = query.trim();
            if (!trimmedQuery) {
                renderFeaturedHadith(homeContentContainer);
                return;
            }
            showLoader(homeContentContainer);
            try {
                const { hits } = await index.search(trimmedQuery, { hitsPerPage: 50 });
                if (hits.length === 0) {
                    homeContentContainer.innerHTML = `<div class="text-center py-10 px-4 hadith-card simpson-border"><p class="text-stone-600 text-lg">لم يتم العثور على نتائج للكلمة: "${sanitizeHTML(trimmedQuery)}"</p></div>`;
                } else {
                    renderSearchResults(hits, homeContentContainer);
                }
            } catch (err) {
                console.error("Search failed:", err);
                homeContentContainer.innerHTML = `<p class="text-center text-red-500 py-10">حدث خطأ أثناء البحث.</p>`;
            }
        };
        
        // --- DETAILS PAGE LOGIC ---
        const renderDetailsPage = async (id) => {
            showView('loader');
            try {
                const response = await fetch(`${ORDS_API_BASE_URL}/${id}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                const hadith = data.items[0];
                if (!hadith) throw new Error('Hadith not found');

                const categoriesHtml = (hadith.categories || '').split('|').map(cat => cat.trim()).filter(Boolean).map(cat =>
                    `<a href="./?q=${encodeURIComponent(cat)}" data-navigate class="inline-block bg-amber-200 text-amber-900 text-sm font-bold me-2 px-4 py-2 rounded-full simpson-button hover:bg-amber-300">
                        ${cat}
                    </a>`
                ).join('');

                const metadataPoints = [
                    { label: 'الراوي', value: hadith.rawi },
                    { label: 'المحدث', value: hadith.muhaddith },
                    { label: 'المصدر', value: hadith.source },
                    { label: 'الصفحة/الرقم', value: hadith.page_number },
                    { label: 'الحكم', value: hadith.hukm },
                ];
                
                const metadataHtml = metadataPoints.filter(item => item.value).map(item => `
                    <div class="py-2"><strong class="text-stone-700 font-bold ml-2">${item.label}:</strong><span>${item.value}</span></div>
                `).join('');

                views.details.innerHTML = `
                    <div class="space-y-8">
                        <div class="hadith-card p-6 simpson-border">
                            <h2 class="text-2xl font-black text-amber-700 mb-3">الحديث</h2>
                            <p class="text-stone-800 whitespace-pre-wrap leading-loose text-xl">${hadith.text}</p>
                        </div>

                        <div class="hadith-card p-6 simpson-border">
                            <h2 class="text-2xl font-black text-amber-700 mb-3">بيانات الحديث</h2>
                            <div class="space-y-1 text-md">${metadataHtml}</div>
                        </div>

                        ${hadith.sharh1 ? `
                        <div class="hadith-card p-6 simpson-border">
                            <h2 class="text-2xl font-black text-amber-700 mb-3">الشرح</h2>
                            <p class="text-stone-800 whitespace-pre-wrap leading-loose text-lg">${hadith.sharh1}</p>
                        </div>` : ''}
                        
                        <div class="flex flex-wrap gap-4 items-center">
                            <button id="similar-search-btn" data-hadith-text="${sanitizeHTML(hadith.text)}" class="simpson-button px-6 py-3 bg-teal-600 text-white rounded-full hover:bg-teal-700">
                                البحث عن المشابه
                            </button>
                             ${categoriesHtml ? `<div class="flex flex-wrap gap-2">${categoriesHtml}</div>` : ''}
                        </div>
                    </div>
                `;
                showView('details');
            } catch (err) {
                console.error("Failed to fetch hadith details:", err);
                views.details.innerHTML = `<p class="text-center text-red-500 py-10 text-lg">حدث خطأ في جلب بيانات الحديث.</p>`;
                showView('details');
            }
        };

        // --- CATEGORY PAGE LOGIC ---
        const renderCategoryPage = async (category) => {
            showView('loader');
            const apiUrl = `https://g85b062bd5c6cb1-fatwaproject.adb.me-dubai-1.oraclecloudapps.com/ords/SUFEAN/hadith/category/${encodeURIComponent(category)}`;
            
            let content = '';
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                if (!data.items || data.items.length === 0) {
                    content = `<div class="text-center py-10 px-4 hadith-card simpson-border"><p class="text-stone-600">لا توجد نتائج في هذا التصنيف.</p></div>`;
                } else {
                    const idKey = data.items[0].hasOwnProperty('id') ? 'id' : 'hadeeth_id';
                    const resultsHTML = data.items.map(h => `
                        <a href="./?id=${h[idKey]}" class="block hadith-card p-5 simpson-border" data-navigate>
                            <p class="text-stone-800 mb-2 text-lg leading-relaxed">${h.text}</p>
                            <div class="text-sm text-stone-600 font-bold">
                                <span>${h.hukm || ''}</span>
                            </div>
                        </a>
                    `).join('');
                    content = `<div class="space-y-6">${resultsHTML}</div>`;
                }
            } catch (err) {
                console.error("Failed to fetch category:", err);
                content = `<div class="text-center py-10 px-4 hadith-card simpson-border"><p class="text-red-500">حدث خطأ أثناء تحميل البيانات.</p></div>`;
            }
            
            views.category.innerHTML = `
                <h1 class="text-3xl font-black text-stone-800 mb-6">
                    أحاديث في: <span class="text-amber-700">${sanitizeHTML(category)}</span>
                </h1>
                ${content}
            `;
            showView('category');
        };


        // --- ROUTER & NAVIGATION ---
        const router = () => {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            const category = params.get('q');
            
            searchForm.classList.toggle('hidden', !!id || !!category);

            if (id) {
                renderDetailsPage(id);
            } else if (category) {
                renderCategoryPage(category);
            } else {
                showView('home');
                const savedQuery = sessionStorage.getItem('hadithSearchQuery');
                if (savedQuery) {
                    searchBox.value = savedQuery;
                    runSearch(savedQuery);
                } else {
                    renderFeaturedHadith(homeContentContainer);
                }
            }
        };

        const navigate = (url, replace = false) => {
            const path = new URL(url, window.location.origin).pathname + new URL(url, window.location.origin).search;
            if (replace) {
                history.replaceState(null, '', path);
            } else {
                history.pushState(null, '', path);
            }
            router();
            window.scrollTo(0, 0);
        };

        // --- EVENT LISTENERS ---
        window.addEventListener('popstate', router);
        
        document.body.addEventListener('click', e => {
            // SPA navigation for links with [data-navigate]
            const anchor = e.target.closest('a[data-navigate]');
            if (anchor) {
                e.preventDefault();
                sessionStorage.removeItem('hadithSearchQuery');
                navigate(anchor.href);
            }

            // "Find Similar" button
            const similarBtn = e.target.closest('#similar-search-btn');
            if (similarBtn) {
                const hadithText = similarBtn.dataset.hadithText;
                if (hadithText) {
                    sessionStorage.setItem('hadithSearchQuery', hadithText);
                    navigate('./');
                }
            }
        });

        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const query = searchBox.value.trim();
            if (query) {
                sessionStorage.setItem('hadithSearchQuery', query);
                navigate(`/?q=${encodeURIComponent(query)}`, true); // Use replace to not clutter history with searches
            }
        });

        backBtn.addEventListener('click', () => {
            history.back();
        });


        // --- INITIALIZATION ---
        initFontSizeControl();
        initDraggable(fabContainer);
        router(); // Initial page load
    });
  </script>
</body>
</html>
