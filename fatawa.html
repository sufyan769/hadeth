<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>الحديث العشوائي الذكي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.20.0/dist/algoliasearch-lite.umd.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- React & Babel for in-browser JSX transformation -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body {
        font-family: 'Tajawal', sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      .animate-fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
    </style>
</head>
<body class="bg-gray-900">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useCallback } = React;

      // --- TYPES (for clarity) ---
      /*
      interface Hadith {
        id: string;
        text: string;
        narrator: string;
        source: string;
        explanation: string;
      }
      */

      // --- ALGOLIA & API CONFIGURATION ---
      const APP_ID = "3XD12I7386";
      const SEARCH_KEY = "89e8e132a05fdb02275f64dec8d14d05";
      const INDEX_NAME = "hadeth-2";
      const ORDS_BASE_URL = 'https://g584d3356027209-ihsan.adb.me-jeddah-1.oraclecloudapps.com/ords/sufean';

      // Initialize Algolia client
      const searchClient = algoliasearch(APP_ID, SEARCH_KEY);
      const hadithIndex = searchClient.initIndex(INDEX_NAME);

      // --- API FUNCTIONS ---
      const fetchRandomHadithId = async () => {
          const response = await fetch(`${ORDS_BASE_URL}/random_hadith/`);
          if (!response.ok) throw new Error(`Failed to fetch random hadith ID: ${response.statusText}`);
          const data = await response.json();
          if (data.items && data.items.length > 0 && data.items[0].id) {
              return String(data.items[0].id);
          }
          throw new Error("Invalid response format for random hadith ID.");
      };

      const fetchHadithById = async (id) => {
          const response = await fetch(`${ORDS_BASE_URL}/hadith_full_api/${id}`);
          if (!response.ok) {
              if (response.status === 404) return undefined;
              throw new Error(`Failed to fetch hadith ${id}: ${response.statusText}`);
          }
          const data = await response.json();
          if (data.items && data.items.length > 0) {
              const item = data.items[0];
              return {
                  id: String(item.id),
                  text: item.text,
                  narrator: item.narrator,
                  source: item.source,
                  explanation: item.explanation,
              };
          }
          return undefined;
      };

      // --- UI ICONS ---
      const SearchIcon = () => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.8} stroke="currentColor" className="w-5 h-5 text-gray-400">
            <path strokeLinecap="round" strokeLinejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
        </svg>
      );
      
      const BackIcon = () => (
         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={3} stroke="currentColor" className="w-4 h-4 text-gray-900">
            <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
        </svg>
      );

      const LoadingSpinner = () => (
          <div className="flex justify-center items-center p-8">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-green-400"></div>
          </div>
      );

      // --- HELPER COMPONENTS ---

      const SearchBarComponent = ({ onSearch, isLoading, showBackButton, onBack }) => {
          const [query, setQuery] = useState('');

          const handleSubmit = (e) => {
              e.preventDefault();
              if (query.trim()) {
                  onSearch(query.trim());
              }
          };

          return (
              <form onSubmit={handleSubmit} className="w-full max-w-2xl mx-auto my-4 sticky top-4 z-10">
                  <div className="relative flex items-center bg-gray-800 border border-gray-700 rounded-full shadow-lg">
                      {showBackButton && (
                        <button type="button" onClick={onBack} className="flex-shrink-0 ml-2 w-9 h-9 flex items-center justify-center bg-green-400 hover:bg-green-500 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-green-300">
                          <BackIcon />
                        </button>
                      )}
                      <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none">
                        <SearchIcon />
                      </div>
                      <input
                          type="search"
                          value={query}
                          onChange={(e) => setQuery(e.target.value)}
                          placeholder="ابحث..."
                          className="w-full py-3 pr-12 pl-4 text-gray-200 bg-transparent rounded-full focus:outline-none"
                          disabled={isLoading}
                      />
                  </div>
              </form>
          );
      };

      const HadithCardComponent = ({ hadith, onFindSimilar, fontSizeClass, onCycleFontSize }) => {
          return (
              <div className="bg-gray-800 rounded-2xl p-6 sm:p-8 my-4 border border-gray-700 w-full animate-fade-in shadow-md">
                  <div className="relative mb-6 pb-4 border-b border-gray-700">
                      <p className={`leading-loose text-gray-200 ${fontSizeClass}`}>{hadith.text}</p>
                      <p className="text-left text-sm text-green-400 mt-4 font-medium">{hadith.narrator} - {hadith.source}</p>
                  </div>
                  <div>
                      <h3 className="font-bold text-lg text-gray-300 mb-2">الشرح:</h3>
                      <p className="text-gray-400 leading-relaxed">{hadith.explanation}</p>
                  </div>
                  <div className="flex items-center justify-start gap-3 mt-8 pt-4 border-t border-gray-700">
                      <button
                          onClick={() => onFindSimilar(hadith)}
                          className="px-4 py-2 bg-gray-700 text-gray-200 font-semibold rounded-full hover:bg-gray-600 transition-colors duration-200"
                      >
                          بحث عن مشابه
                      </button>
                      <button
                          onClick={onCycleFontSize}
                          className="p-2.5 text-gray-400 hover:text-white hover:bg-gray-700 rounded-full transition-colors duration-200"
                          title="تكبير النص"
                      >
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5">
                            <path strokeLinecap="round" strokeLinejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25H12" />
                          </svg>
                      </button>
                  </div>
              </div>
          );
      };

      // --- MAIN APP COMPONENT ---
      function App() {
          const [view, setView] = useState('discovery');
          const [hadithOfTheDay, setHadithOfTheDay] = useState(null);
          const [searchResults, setSearchResults] = useState([]);
          const [isLoading, setIsLoading] = useState(true);
          const [error, setError] = useState(null);

          const fontSizeClasses = ['text-xl', 'text-2xl', 'text-3xl'];
          const [fontSizeLevel, setFontSizeLevel] = useState(0);
          const cycleFontSize = () => setFontSizeLevel(prev => (prev + 1) % fontSizeClasses.length);
          const currentFontSizeClass = fontSizeClasses[fontSizeLevel];

          const loadDiscoveryHadith = useCallback(async () => {
              setIsLoading(true);
              setError(null);
              setSearchResults([]);
              try {
                  const randomId = await fetchRandomHadithId();
                  const hadith = await fetchHadithById(randomId);
                  if (hadith) {
                      setHadithOfTheDay(hadith);
                      setView('discovery');
                  } else {
                      throw new Error("لم يتم العثور على الحديث.");
                  }
              } catch (err) {
                  setError("حدث خطأ أثناء تحميل حديث اليوم. الرجاء المحاولة مرة أخرى.");
                  console.error(err);
              } finally {
                  setIsLoading(false);
              }
          }, []);

          useEffect(() => {
              loadDiscoveryHadith();
          }, []);

          const handleSearch = useCallback(async (query, excludeId) => {
              setIsLoading(true);
              setError(null);
              setView('search');
              setSearchResults([]);
              try {
                  const searchOptions = {};
                  if (excludeId) {
                      searchOptions.facetFilters = [[`objectID:-${excludeId}`]];
                  }
                  const { hits } = await hadithIndex.search(query, searchOptions);
                  const hadithIds = hits.map(hit => hit.objectID).slice(0, 5);

                  if (hadithIds.length === 0) {
                    setSearchResults([]);
                    return;
                  }
                  
                  const fullHadiths = (await Promise.all(
                      hadithIds.map(id => fetchHadithById(id))
                  )).filter(h => h !== undefined);

                  setSearchResults(fullHadiths);

              } catch (err) {
                  setError("حدث خطأ أثناء البحث. الرجاء المحاولة مرة أخرى.");
                  console.error(err);
              } finally {
                  setIsLoading(false);
              }
          }, []);
          
          const handleFindSimilar = useCallback((hadith) => {
              const query = hadith.text.split(' ').slice(0, 5).join(' ');
              handleSearch(query, hadith.id);
              window.scrollTo(0, 0);
          }, [handleSearch]);

          return (
              <div className="min-h-screen text-gray-200">
                  <div className="container mx-auto px-4 py-6 max-w-2xl">

                      <SearchBarComponent 
                        onSearch={handleSearch} 
                        isLoading={isLoading}
                        showBackButton={view === 'search'}
                        onBack={loadDiscoveryHadith}
                      />

                      <main className="mt-4">
                          {error && <p className="text-center text-red-300 bg-red-900/50 p-4 rounded-lg">{error}</p>}
                          
                          {isLoading && <LoadingSpinner />}

                          {!isLoading && !error && (
                              <>
                                  {view === 'discovery' && hadithOfTheDay && (
                                      <>
                                        <h2 className="text-2xl font-semibold text-center text-gray-400 mb-4">حديث اليوم</h2>
                                        <HadithCardComponent 
                                          hadith={hadithOfTheDay} 
                                          onFindSimilar={handleFindSimilar}
                                          fontSizeClass={currentFontSizeClass}
                                          onCycleFontSize={cycleFontSize}
                                        />
                                      </>
                                  )}
                                  
                                  {view === 'search' && (
                                      <>
                                          <h2 className="text-2xl font-semibold text-right text-gray-400 mb-4">نتائج البحث</h2>
                                          {searchResults.length > 0 ? (
                                              searchResults.map(hadith => (
                                                  <HadithCardComponent 
                                                    key={hadith.id} 
                                                    hadith={hadith} 
                                                    onFindSimilar={handleFindSimilar}
                                                    fontSizeClass={currentFontSizeClass}
                                                    onCycleFontSize={cycleFontSize}
                                                  />
                                              ))
                                          ) : (
                                              <div className="text-center p-8 bg-gray-800 rounded-lg shadow">
                                                  <p className="text-gray-400">لم يتم العثور على نتائج.</p>
                                              </div>
                                          )}
                                      </>
                                  )}
                              </>
                          )}
                      </main>

                  </div>
              </div>
          );
      }

      // --- RENDER THE APP ---
      const rootElement = document.getElementById('root');
      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
</body>
</html>
